# PortOne V2 ê²°ì œ ì—°ë™ ê°€ì´ë“œ

> ë‹¤ë¥¸ Replit í”„ë¡œì íŠ¸ì—ì„œ ê²°ì œ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ë•Œ ì°¸ê³ í•˜ëŠ” ì¢…í•© ê°€ì´ë“œì…ë‹ˆë‹¤.
> ì´ ë¬¸ì„œëŠ” VidDigest Hub í”„ë¡œì íŠ¸ì—ì„œ ì‹œí–‰ì°©ì˜¤ë¥¼ ê±°ì³ ì™„ì„±ëœ ë‚´ìš©ì…ë‹ˆë‹¤.

---

## ëª©ì°¨

1. [ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­](#1-ì‚¬ì „-ì¤€ë¹„-ì‚¬í•­)
2. [í™˜ê²½ ë³€ìˆ˜ ì„¤ì •](#2-í™˜ê²½-ë³€ìˆ˜-ì„¤ì •)
3. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#3-ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
4. [ë°±ì—”ë“œ ì„œë¹„ìŠ¤ êµ¬í˜„](#4-ë°±ì—”ë“œ-ì„œë¹„ìŠ¤-êµ¬í˜„)
5. [í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„](#5-í”„ë¡ íŠ¸ì—”ë“œ-êµ¬í˜„)
6. [ê²°ì œ ìˆ˜ë‹¨ë³„ íŠ¹ì´ì‚¬í•­](#6-ê²°ì œ-ìˆ˜ë‹¨ë³„-íŠ¹ì´ì‚¬í•­)
7. [ì •ê¸°ê²°ì œ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ (í•µì‹¬!)](#7-ì •ê¸°ê²°ì œ-ìŠ¤ì¼€ì¤„-ê´€ë¦¬-í•µì‹¬)
8. [êµ¬ë… í•´ì§€ vs í™˜ë¶ˆ - í•µì‹¬ ê°œë… ë¶„ë¦¬ (CRITICAL!)](#8-êµ¬ë…-í•´ì§€-vs-í™˜ë¶ˆ---í•µì‹¬-ê°œë…-ë¶„ë¦¬-critical)
9. [í™˜ë¶ˆ ì •ì±… (í•œêµ­ ì „ììƒê±°ë˜ë²• ì¤€ìˆ˜)](#9-í™˜ë¶ˆ-ì •ì±…-í•œêµ­-ì „ììƒê±°ë˜ë²•-ì¤€ìˆ˜)
10. [ì—…ê·¸ë ˆì´ë“œ ì‹œ ìë™ í™˜ë¶ˆ ë¡œì§](#10-ì—…ê·¸ë ˆì´ë“œ-ì‹œ-ìë™-í™˜ë¶ˆ-ë¡œì§)
11. [PGì‚¬ ì‹¬ì‚¬ í•„ìˆ˜ í˜ì´ì§€](#11-pgì‚¬-ì‹¬ì‚¬-í•„ìˆ˜-í˜ì´ì§€)
12. [í…ŒìŠ¤íŠ¸ í™˜ê²½ ì£¼ì˜ì‚¬í•­](#12-í…ŒìŠ¤íŠ¸-í™˜ê²½-ì£¼ì˜ì‚¬í•­)
13. [ê´€ë¦¬ì ê¸°ëŠ¥](#13-ê´€ë¦¬ì-ê¸°ëŠ¥)
14. [ì¼ë°˜ì ì¸ ì‹¤ìˆ˜ì™€ í•´ê²°ì±…](#14-ì¼ë°˜ì ì¸-ì‹¤ìˆ˜ì™€-í•´ê²°ì±…)
15. [ì²´í¬ë¦¬ìŠ¤íŠ¸](#15-ì²´í¬ë¦¬ìŠ¤íŠ¸)
16. [ê°œë°œ ëŒ€ì›ì¹™](#16-ê°œë°œ-ëŒ€ì›ì¹™)

---

## 1. ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­

### PortOne ì½˜ì†” ì„¤ì •

1. [PortOne ì½˜ì†”](https://admin.portone.io) ì ‘ì†
2. ìŠ¤í† ì–´ ìƒì„± â†’ `store-xxxxx` ID í™•ì¸
3. ì±„ë„ ì¶”ê°€:
   - **KGì´ë‹ˆì‹œìŠ¤ V2**: ì •ê¸°ê²°ì œìš© (ì¹´ë“œ)
   - **ì¹´ì¹´ì˜¤í˜ì´**: ì •ê¸°ê²°ì œìš© (ê°„í¸ê²°ì œ)
   - **PayPal V2**: RT(Reference Transaction) ì •ê¸°ê²°ì œìš© (í•´ì™¸ê²°ì œ)

### PGì‚¬ë³„ ê³„ì•½ í•„ìš”

| PGì‚¬ | ê³„ì•½ í˜•íƒœ | í…ŒìŠ¤íŠ¸ MID |
|------|----------|-----------|
| KGì´ë‹ˆì‹œìŠ¤ | ì •ê¸°ê²°ì œ(ë¹Œë§) ë³„ë„ ê³„ì•½ | `INIBillTst` |
| ì¹´ì¹´ì˜¤í˜ì´ | ì •ê¸°ê²°ì œ ê³„ì•½ | `TCSUBSCRIP` |
| PayPal | RT(Reference Transaction) ìŠ¹ì¸ í•„ìš” | Sandbox ê³„ì • |

### í•„ìˆ˜ NPM íŒ¨í‚¤ì§€

```bash
npm install jsonwebtoken bcrypt
npm install @types/jsonwebtoken @types/bcrypt --save-dev
```

---

## 2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

### Secrets (ë¯¼ê° ì •ë³´)

```env
# PortOne í•„ìˆ˜
PORTONE_API_SECRET=your_portone_api_secret
PORTONE_STORE_ID=store-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# ê²°ì œ ì±„ë„ë³„ í‚¤
PORTONE_CHANNEL_KEY=channel-key-xxxxx  # KGì´ë‹ˆì‹œìŠ¤ (ì¹´ë“œ)
PORTONE_KAKAOPAY_CHANNEL_KEY=channel-key-xxxxx  # ì¹´ì¹´ì˜¤í˜ì´
PORTONE_PAYPAL_CHANNEL_KEY=channel-key-xxxxx  # PayPal

# Webhook ê²€ì¦ (ì„ íƒ)
PORTONE_WEBHOOK_SECRET=your_webhook_secret

# ì´ë©”ì¼ ì•Œë¦¼
RESEND_API_KEY=re_xxxxx

# ê´€ë¦¬ì ê³„ì • (í…ŒìŠ¤íŠ¸ìš© 1ì› ê²°ì œ)
ADMIN_EMAILS=admin1@example.com,admin2@example.com
```

### ì±„ë„ í‚¤ í™•ì¸ ë°©ë²•

1. PortOne ì½˜ì†” â†’ ê²°ì œ ì—°ë™ â†’ ì±„ë„ ê´€ë¦¬
2. ê° ì±„ë„ì˜ "ì±„ë„ í‚¤" ë³µì‚¬
3. ì±„ë„ í‚¤ëŠ” `channel-key-`ë¡œ ì‹œì‘

---

## 3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### í•„ìˆ˜ í…Œì´ë¸”

```typescript
// shared/schema.ts

// 1. ìš”ê¸ˆì œ ì •ì˜
export const billingPlans = pgTable('billing_plans', {
  id: text('id').primaryKey(),  // 'app_free', 'app_basic', 'app_pro'
  app: text('app').notNull().default('myapp'),
  name: text('name').notNull(),  // 'Free', 'Basic', 'Pro'
  priceMonthlyKrw: integer('price_monthly_krw').notNull().default(0),
  priceMonthlyUsd: text('price_monthly_usd'),  // PayPalìš© (ì˜ˆ: "6.60")
  features: jsonb('features').notNull(),  // JSON: { summary_limit_day, summary_limit_month, ... }
  sortOrder: integer('sort_order').notNull().default(0),
  isActive: boolean('is_active').notNull().default(true),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),
});

// 2. ì‚¬ìš©ì êµ¬ë… ì •ë³´
export const userSubscriptions = pgTable('user_subscriptions', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: text('user_id').notNull(),
  app: text('app').notNull().default('myapp'),
  planId: text('plan_id').notNull(),
  status: text('status').notNull().default('active'),  // 'active' | 'cancelled' | 'past_due' | 'expired'
  portoneSubscriptionId: text('portone_subscription_id'),
  portoneScheduleId: text('portone_schedule_id'),  // ë‹¤ìŒ ê²°ì œ ìŠ¤ì¼€ì¤„ ID
  billingKeyId: text('billing_key_id'),  // ì •ê¸°ê²°ì œìš© ë¹Œë§í‚¤
  paymentMethod: text('payment_method'),  // 'card' | 'kakaopay' | 'paypal'
  currentPeriodStart: timestamp('current_period_start', { withTimezone: true }),
  currentPeriodEnd: timestamp('current_period_end', { withTimezone: true }),
  canceledAt: timestamp('canceled_at', { withTimezone: true }),  // nullì´ë©´ í•´ì§€ ì•ˆí•¨
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),
});

// 3. ê²°ì œ ë‚´ì—­
export const paymentTransactions = pgTable('payment_transactions', {
  id: uuid('id').primaryKey().defaultRandom(),
  subscriptionId: uuid('subscription_id').notNull(),
  portonePaymentId: text('portone_payment_id'),
  amount: integer('amount').notNull(),
  currency: text('currency').notNull().default('KRW'),
  status: text('status').notNull(),  // 'paid' | 'refunded' | 'failed'
  paymentMethod: text('payment_method'),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});

// 4. í™˜ë¶ˆ ìš”ì²­
export const refundRequests = pgTable('refund_requests', {
  id: uuid('id').primaryKey().defaultRandom(),
  subscriptionId: uuid('subscription_id').notNull(),
  userId: text('user_id').notNull(),
  reason: text('reason').notNull(),
  refundAmount: integer('refund_amount'),
  status: text('status').notNull().default('pending'),  // 'pending' | 'approved' | 'rejected'
  adminNote: text('admin_note'),
  processedAt: timestamp('processed_at', { withTimezone: true }),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
});

// 5. ì‚¬ìš©ëŸ‰ ì¶”ì 
export const userUsage = pgTable('user_usage', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: text('user_id').notNull(),
  usageKey: text('usage_key').notNull(),  // 'summary_count' | 'search_count'
  periodStart: date('period_start').notNull(),
  periodEnd: date('period_end').notNull(),
  usedInPeriod: integer('used_in_period').notNull().default(0),
  limitInPeriod: integer('limit_in_period').notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).notNull().defaultNow(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).notNull().defaultNow(),
});
```

### ì´ˆê¸° ë°ì´í„° ì‚½ì… (ìš”ê¸ˆì œ)

```sql
INSERT INTO billing_plans (id, app, name, price_monthly_krw, price_monthly_usd, features, sort_order, is_active) VALUES
('myapp_free', 'myapp', 'Free', 0, '0', '{"summary_limit_day": 5, "summary_limit_month": 10, "search_limit_month": 50}', 0, true),
('myapp_basic', 'myapp', 'Basic', 4900, '3.30', '{"summary_limit_day": null, "summary_limit_month": 60, "search_limit_month": 300}', 1, true),
('myapp_pro', 'myapp', 'Pro', 9900, '6.60', '{"summary_limit_day": null, "summary_limit_month": 150, "search_limit_month": 2000}', 2, true);
```

---

## 4. ë°±ì—”ë“œ ì„œë¹„ìŠ¤ êµ¬í˜„

### 4.1 ê´€ë¦¬ì ì„¤ì • (server/config/admin.ts)

```typescript
const ADMIN_EMAILS_ENV = process.env.ADMIN_EMAILS || '';

export const ADMIN_EMAILS: string[] = ADMIN_EMAILS_ENV
  .split(',')
  .map(email => email.trim().toLowerCase())
  .filter(email => email.length > 0);

export function isAdminEmail(email: string | null | undefined): boolean {
  if (!email) return false;
  return ADMIN_EMAILS.includes(email.toLowerCase());
}
```

### 4.2 PortOne ì„œë¹„ìŠ¤ í•µì‹¬ ë©”ì„œë“œ

```typescript
// server/services/portone.ts

class PortOneService {
  private apiUrl = 'https://api.portone.io';
  
  private getConfig() {
    const apiSecret = process.env.PORTONE_API_SECRET;
    const storeId = process.env.PORTONE_STORE_ID;
    const channelKey = process.env.PORTONE_CHANNEL_KEY;
    
    if (!apiSecret || !storeId) {
      throw new Error('PortOne configuration missing');
    }
    
    return { apiSecret, storeId, channelKey };
  }
  
  // ë¹Œë§í‚¤ë¡œ ê²°ì œ ì‹¤í–‰
  async createPayment(params: {
    paymentId: string;
    billingKey: string;
    orderName: string;
    amount: number;
    currency?: string;  // 'KRW' | 'USD'
    customer: { id: string; email: string };
  }) {
    const config = this.getConfig();
    
    const response = await fetch(`${this.apiUrl}/payments/${params.paymentId}/billing-key`, {
      method: 'POST',
      headers: {
        'Authorization': `PortOne ${config.apiSecret}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        billingKey: params.billingKey,
        orderName: params.orderName,
        amount: { total: params.amount },
        currency: params.currency || 'KRW',
        customer: params.customer,
      }),
    });
    
    return response.json();
  }
  
  // ì •ê¸° ê²°ì œ ìŠ¤ì¼€ì¤„ ë“±ë¡
  async schedulePayment(params: {
    scheduleId: string;
    billingKey: string;
    orderName: string;
    amount: number;
    scheduledAt: Date;
    customer: { id: string; email: string };
  }) {
    const config = this.getConfig();
    
    const response = await fetch(`${this.apiUrl}/payments/${params.scheduleId}/schedule`, {
      method: 'POST',
      headers: {
        'Authorization': `PortOne ${config.apiSecret}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        payment: {
          billingKey: params.billingKey,
          orderName: params.orderName,
          amount: { total: params.amount },
          currency: 'KRW',
          customer: params.customer,
        },
        timeToPay: params.scheduledAt.toISOString(),
      }),
    });
    
    return response.json();
  }
  
  // ìŠ¤ì¼€ì¤„ ì·¨ì†Œ (DELETE ë©”ì„œë“œ!)
  async cancelSchedule(scheduleId: string) {
    const config = this.getConfig();
    
    const response = await fetch(`${this.apiUrl}/payment-schedules/${scheduleId}`, {
      method: 'DELETE',  // POSTê°€ ì•„ë‹ˆë¼ DELETE!
      headers: {
        'Authorization': `PortOne ${config.apiSecret}`,
      },
    });
    
    if (!response.ok && response.status !== 404) {
      throw new Error('ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ì‹¤íŒ¨');
    }
  }
  
  // ê²°ì œ ì·¨ì†Œ (í™˜ë¶ˆ)
  async cancelPayment(paymentId: string, reason: string) {
    const config = this.getConfig();
    
    const response = await fetch(`${this.apiUrl}/payments/${paymentId}/cancel`, {
      method: 'POST',
      headers: {
        'Authorization': `PortOne ${config.apiSecret}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ reason }),
    });
    
    return response.json();
  }
}
```

### 4.3 API ë¼ìš°íŠ¸

```typescript
// server/routes/billing.ts

// 1. PortOne ì„¤ì • ìƒíƒœ í™•ì¸
router.get('/portone/status', async (req, res) => {
  const isConfigured = await portoneService.isConfigured();
  res.json({ configured: isConfigured });
});

// 2. í”„ë¡ íŠ¸ì—”ë“œìš© ì„¤ì • ì •ë³´ (ì¸ì¦ í•„ìš”)
router.get('/portone/config', authMiddleware, async (req, res) => {
  res.json({
    storeId: process.env.PORTONE_STORE_ID,
    channelKey: process.env.PORTONE_CHANNEL_KEY,
    paypalChannelKey: process.env.PORTONE_PAYPAL_CHANNEL_KEY || null,
    kakaopayChannelKey: process.env.PORTONE_KAKAOPAY_CHANNEL_KEY || null,
  });
});

// 3. êµ¬ë… ì‹œì‘ (ë¹Œë§í‚¤ë¡œ ì²« ê²°ì œ)
router.post('/subscribe', authMiddleware, async (req, res) => {
  const { planId, billingKey, paymentMethod } = req.body;
  const result = await billingService.createSubscription({
    userId: req.user.id,
    userEmail: req.user.email,
    planId,
    billingKey,
    paymentMethod,
  });
  res.json(result);
});

// 4. êµ¬ë… í•´ì§€ (ë‹¤ìŒ ê²°ì œ ì¤‘ë‹¨, í˜„ì¬ í”Œëœ ìœ ì§€!)
router.post('/cancel', authMiddleware, async (req, res) => {
  const subscription = await billingService.getUserSubscription(req.user.id);
  
  // âš ï¸ ì¤‘ìš”: canceledAtë§Œ ì„¤ì •, í”Œëœì€ ìœ ì§€!
  await portoneService.cancelSubscription(subscription.id, req.user.email);
  
  res.json({ 
    message: `êµ¬ë… í•´ì§€ê°€ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤. ${subscription.currentPeriodEnd}ê¹Œì§€ í˜„ì¬ í”Œëœì„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  });
});

// 5. í™˜ë¶ˆ ìš”ì²­
router.post('/refund-request', authMiddleware, async (req, res) => {
  const { reason } = req.body;
  const result = await billingService.createRefundRequest(req.user.id, reason);
  res.json(result);
});

// 6. ê´€ë¦¬ì: í™˜ë¶ˆ ìŠ¹ì¸ (ì´ë•Œë§Œ Free í”Œëœ ì „í™˜!)
router.post('/admin/refunds/:id/approve', authMiddleware, adminMiddleware, async (req, res) => {
  const { id } = req.params;
  const { adminNote, refundAmount } = req.body;
  
  // 1. PortOne APIë¡œ ì‹¤ì œ ê²°ì œ ì·¨ì†Œ
  const refundRequest = await storage.getRefundRequest(id);
  const payment = await storage.getPaymentTransactionBySubscriptionId(refundRequest.subscriptionId);
  await portoneService.cancelPayment(payment.portonePaymentId, adminNote || 'Admin approved refund');
  
  // 2. ì´ë•Œë§Œ Free í”Œëœ ì „í™˜!
  await billingService.cancelSubscription(refundRequest.subscriptionId);
  
  // 3. í™˜ë¶ˆ ìš”ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
  await storage.updateRefundRequest(id, { status: 'approved', adminNote, processedAt: new Date() });
  
  res.json({ success: true });
});

// 7. Webhook ìˆ˜ì‹ 
router.post('/webhook', async (req, res) => {
  await portoneService.handleWebhook(req.body);
  res.json({ received: true });
});
```

### 4.4 ì´ë©”ì¼ ì„œë¹„ìŠ¤ (Resend)

```typescript
// server/services/email.ts

class EmailService {
  private fromEmail = 'YourApp <noreply@resend.dev>';
  
  async send(options: { to: string; subject: string; html: string }) {
    const apiKey = process.env.RESEND_API_KEY;
    
    const response = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        from: this.fromEmail,
        to: options.to,
        subject: options.subject,
        html: options.html,
      }),
    });
    
    return response.json();
  }
  
  async sendPaymentConfirmation(params: {
    to: string;
    planName: string;
    amount: number;
    nextBillingDate: Date;
  }) {
    const html = `... ê²°ì œ ì™„ë£Œ ì´ë©”ì¼ HTML ...`;
    return this.send({
      to: params.to,
      subject: `[ì•±ì´ë¦„] ${params.planName} ê²°ì œ ì™„ë£Œ`,
      html,
    });
  }
  
  async sendSubscriptionCanceled(params: {
    to: string;
    planName: string;
    expiryDate: Date;
  }) {
    const html = `... í•´ì§€ ì•ˆë‚´ ì´ë©”ì¼ HTML ...`;
    return this.send({
      to: params.to,
      subject: `[ì•±ì´ë¦„] êµ¬ë… í•´ì§€ ì˜ˆì • ì•ˆë‚´`,
      html,
    });
  }
}

export const emailService = new EmailService();
```

---

## 5. í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 5.1 PortOne SDK ë¡œë“œ

```typescript
// HTML headì— SDK ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ (index.html)
<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

// TypeScript íƒ€ì… ì„ ì–¸
declare global {
  interface Window {
    PortOne?: {
      requestIssueBillingKey: (params: any) => Promise<any>;
      loadIssueBillingKeyUI: (params: any, callbacks: any) => Promise<void>;
    };
  }
}

// SDK ë¡œë“œ ëŒ€ê¸° í•¨ìˆ˜
const waitForPortOne = (): Promise<typeof window.PortOne> => {
  return new Promise((resolve, reject) => {
    if (window.PortOne) {
      resolve(window.PortOne);
      return;
    }
    
    let attempts = 0;
    const maxAttempts = 50;
    const interval = setInterval(() => {
      attempts++;
      if (window.PortOne) {
        clearInterval(interval);
        resolve(window.PortOne);
      } else if (attempts >= maxAttempts) {
        clearInterval(interval);
        reject(new Error('PortOne SDK ë¡œë“œ ì‹¤íŒ¨'));
      }
    }, 100);
  });
};
```

### 5.2 ì¹´ë“œ / ì¹´ì¹´ì˜¤í˜ì´ ë¹Œë§í‚¤ ë°œê¸‰

```typescript
const handlePayment = async () => {
  const PortOne = await waitForPortOne();
  
  // ê²°ì œ ë°©ë²•ì— ë”°ë¼ ì„¤ì •
  let channelKey: string;
  let billingKeyMethod: string;
  
  if (paymentMethod === 'kakaopay') {
    channelKey = portoneConfig.kakaopayChannelKey!;
    billingKeyMethod = 'EASY_PAY';
  } else {
    channelKey = portoneConfig.channelKey;
    billingKeyMethod = 'CARD';
  }
  
  // ê³ ìœ í•œ issueId ìƒì„± (ì¤‘ìš”!)
  const issueId = `app_${paymentMethod}_${userId.slice(0, 8)}_${Date.now().toString(36)}`;
  
  const requestParams: any = {
    storeId: portoneConfig.storeId,
    channelKey,
    billingKeyMethod,
    issueId,
    issueName: `ì•±ì´ë¦„ ${planName} ì •ê¸°êµ¬ë…`,
    customer: {
      customerId: user.id,
      email: user.email,
      phoneNumber: customerPhone,
      fullName: user.displayName || user.email.split('@')[0],
    },
  };
  
  // ì¹´ì¹´ì˜¤í˜ì´ ì „ìš© ì„¤ì • (í•„ìˆ˜!)
  if (paymentMethod === 'kakaopay') {
    requestParams.windowType = {
      pc: 'IFRAME',      // PCëŠ” IFRAMEë§Œ ì§€ì›
      mobile: 'REDIRECTION'  // ëª¨ë°”ì¼ì€ REDIRECTIONë§Œ ì§€ì›
    };
    requestParams.redirectUrl = window.location.href;
  }
  
  const response = await PortOne.requestIssueBillingKey(requestParams);
  
  if (response.code) {
    toast.error(response.message || 'ê²°ì œ ë“±ë¡ ì‹¤íŒ¨');
    return;
  }
  
  // ì„±ê³µ: billingKeyë¡œ êµ¬ë… ì‹œì‘ API í˜¸ì¶œ
  await subscribeMutation.mutateAsync({
    planId: selectedPlan,
    billingKey: response.billingKey,
    paymentMethod,
  });
};
```

### 5.3 PayPal ë¹Œë§í‚¤ ë°œê¸‰ (íŠ¹ìˆ˜ ì²˜ë¦¬)

```typescript
// PayPalì€ loadIssueBillingKeyUI ì‚¬ìš© (ë²„íŠ¼ ë Œë”ë§ ë°©ì‹)
// React DOM ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ìˆ˜ë™ìœ¼ë¡œ DOM ìš”ì†Œ ê´€ë¦¬ í•„ìˆ˜!

const paypalContainerRef = useRef<HTMLDivElement>(null);
const paypalHostRef = useRef<HTMLDivElement | null>(null);

useEffect(() => {
  if (paymentMethod !== 'paypal' || !showCheckoutDialog) return;
  
  let isMounted = true;
  let hostElement: HTMLDivElement | null = null;
  
  const renderPaypalButton = async () => {
    const PortOne = await waitForPortOne();
    if (!PortOne.loadIssueBillingKeyUI || !paypalContainerRef.current) return;
    
    // React ì™¸ë¶€ì—ì„œ ê´€ë¦¬í•  DOM ìš”ì†Œ ìƒì„± (ì¤‘ìš”!)
    hostElement = document.createElement('div');
    hostElement.className = 'portone-ui-container';
    hostElement.style.minHeight = '50px';
    paypalContainerRef.current.appendChild(hostElement);
    paypalHostRef.current = hostElement;
    
    const issueId = `app_paypal_${userId.slice(0, 8)}_${Date.now().toString(36)}`;
    
    await PortOne.loadIssueBillingKeyUI(
      {
        uiType: 'PAYPAL_RT',
        storeId: portoneConfig.storeId,
        channelKey: portoneConfig.paypalChannelKey!,
        issueId,
        issueName: `ì•±ì´ë¦„ ${planName} ì •ê¸°êµ¬ë…`,
        customer: {
          customerId: user.id,
          email: user.email,
          fullName: user.displayName,
        },
      },
      {
        onIssueBillingKeySuccess: handlePaypalSuccess,
        onIssueBillingKeyFail: handlePaypalFail,
      }
    );
  };
  
  const timeout = setTimeout(renderPaypalButton, 500);
  
  return () => {
    isMounted = false;
    clearTimeout(timeout);
    // React unmount ì „ì— ìˆ˜ë™ìœ¼ë¡œ DOM ì •ë¦¬ (í•„ìˆ˜!)
    if (hostElement && hostElement.parentNode) {
      hostElement.parentNode.removeChild(hostElement);
    }
    if (paypalHostRef.current && paypalHostRef.current.parentNode) {
      paypalHostRef.current.parentNode.removeChild(paypalHostRef.current);
    }
    paypalHostRef.current = null;
  };
}, [paymentMethod, showCheckoutDialog, user, selectedPlan, portoneConfig]);
```

### 5.4 ê²°ì œ UI (ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ)

```tsx
<div className="grid grid-cols-3 gap-2">
  {/* ì¹´ë“œ */}
  <button
    onClick={() => setPaymentMethod('card')}
    className={paymentMethod === 'card' ? 'border-primary' : ''}
  >
    ğŸ’³ ì¹´ë“œ
  </button>
  
  {/* ì¹´ì¹´ì˜¤í˜ì´ */}
  <button
    onClick={() => setPaymentMethod('kakaopay')}
    disabled={!portoneConfig?.kakaopayChannelKey}
  >
    ğŸŸ¡ ì¹´ì¹´ì˜¤í˜ì´
  </button>
  
  {/* PayPal */}
  <button
    onClick={() => setPaymentMethod('paypal')}
    disabled={!portoneConfig?.paypalChannelKey}
  >
    ğŸ’™ PayPal
  </button>
</div>

{/* PayPal ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */}
{paymentMethod === 'paypal' && (
  <div ref={paypalContainerRef} className="min-h-[50px]">
    {!isPaypalButtonRendered && <Loader2 className="animate-spin" />}
  </div>
)}
```

---

## 6. ê²°ì œ ìˆ˜ë‹¨ë³„ íŠ¹ì´ì‚¬í•­

### 6.1 KGì´ë‹ˆì‹œìŠ¤ (ì¹´ë“œ)

| í•­ëª© | ë‚´ìš© |
|------|------|
| billingKeyMethod | `'CARD'` |
| ì¸ì¦ ë°©ì‹ | SMS ì¸ì¦ (PASS ë³„ë„ ê³„ì•½ í•„ìš”) |
| í…ŒìŠ¤íŠ¸ MID | `INIBillTst` |
| í…ŒìŠ¤íŠ¸ í™˜ê²½ | SMS ë¯¸ë°œì†¡ (ì‹¤ì„œë¹„ìŠ¤ MID í•„ìš”) |

### 6.2 ì¹´ì¹´ì˜¤í˜ì´

| í•­ëª© | ë‚´ìš© |
|------|------|
| billingKeyMethod | `'EASY_PAY'` |
| windowType í•„ìˆ˜ | `{ pc: 'IFRAME', mobile: 'REDIRECTION' }` |
| redirectUrl | PCì—ì„œë„ í•„ìˆ˜ ì„¤ì • |
| issueName | í•„ìˆ˜ (êµ¬ë… ì„¤ëª…) |

**ì£¼ì˜:** windowType ë¯¸ì„¤ì • ì‹œ ì—ëŸ¬ ë°œìƒ!

### 6.3 PayPal (RT)

| í•­ëª© | ë‚´ìš© |
|------|------|
| ë°œê¸‰ ë°©ì‹ | `loadIssueBillingKeyUI` (ë²„íŠ¼ ë Œë”ë§) |
| uiType | `'PAYPAL_RT'` |
| RT ìŠ¹ì¸ | PayPal Business ê³„ì •ì—ì„œ ë³„ë„ ìŠ¹ì¸ í•„ìš” |
| Sandbox OTP | `123456` ë˜ëŠ” ë³„ë„ ì„¤ì •ëœ ì½”ë“œ |
| í†µí™” | USD (í™˜ë¶ˆ ì‹œ 3% ìˆ˜ìˆ˜ë£Œ) |

**ì£¼ì˜ì‚¬í•­:**
- React DOM ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ ìˆ˜ë™ DOM ê´€ë¦¬ í•„ìˆ˜
- Sandboxì—ì„œëŠ” SMS ë¯¸ë°œì†¡
- í•œêµ­ ì‚¬ì—…ìëŠ” RT ìŠ¹ì¸ ì ˆì°¨ í•„ìš”

---

## 7. ì •ê¸°ê²°ì œ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ (í•µì‹¬!)

> âš ï¸ **ì´ ì„¹ì…˜ì€ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤!** ì´ ë¶€ë¶„ì„ ì˜ëª» êµ¬í˜„í•˜ë©´ 2ê°œì›” í›„ë¶€í„° ìë™ê²°ì œê°€ ì•ˆ ë©ë‹ˆë‹¤.

### 7.1 PortOne V2 ìŠ¤ì¼€ì¤„ ë™ì‘ ì›ë¦¬

**í•µì‹¬ ê°œë…:** PortOne V2ì˜ ì •ê¸°ê²°ì œ ìŠ¤ì¼€ì¤„ì€ **1íšŒì„±**ì…ë‹ˆë‹¤. ì¦‰, í•œ ë²ˆ ìŠ¤ì¼€ì¤„ì„ ë“±ë¡í•˜ë©´ í•´ë‹¹ ë‚ ì§œì— 1íšŒë§Œ ê²°ì œê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. ë§¤ì›” ìë™ê²°ì œë¥¼ ìœ„í•´ì„œëŠ” **ë§¤ë²ˆ ë‹¤ìŒ ë‹¬ ìŠ¤ì¼€ì¤„ì„ ìƒˆë¡œ ë“±ë¡**í•´ì•¼ í•©ë‹ˆë‹¤.

```
1ì›” 1ì¼: ì²« ê²°ì œ + 2ì›” ìŠ¤ì¼€ì¤„ ë“±ë¡
    â†“
2ì›” 1ì¼: PortOneì´ ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ìë™) â†’ Webhook ìˆ˜ì‹  â†’ 3ì›” ìŠ¤ì¼€ì¤„ ë“±ë¡ (í•„ìˆ˜!)
    â†“
3ì›” 1ì¼: PortOneì´ ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ìë™) â†’ Webhook ìˆ˜ì‹  â†’ 4ì›” ìŠ¤ì¼€ì¤„ ë“±ë¡ (í•„ìˆ˜!)
    â†“
... ë¬´í•œ ë°˜ë³µ
```

### 7.2 PortOne V2 ìŠ¤ì¼€ì¤„ API ì—”ë“œí¬ì¸íŠ¸

> âš ï¸ **ì£¼ì˜:** PortOne V2 ë¬¸ì„œê°€ í˜¼ë€ìŠ¤ëŸ½ìŠµë‹ˆë‹¤. ì•„ë˜ê°€ **ì‹¤ì œ ë™ì‘í•˜ëŠ”** ì—”ë“œí¬ì¸íŠ¸ì…ë‹ˆë‹¤.

| ê¸°ëŠ¥ | HTTP ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ |
|------|-----------|-----------|
| ìŠ¤ì¼€ì¤„ ë“±ë¡ | `POST` | `/payments/{paymentId}/schedule` |
| ìŠ¤ì¼€ì¤„ ì¡°íšŒ | `GET` | `/payments/{paymentId}/schedule` |
| ìŠ¤ì¼€ì¤„ ì·¨ì†Œ | `DELETE` | `/payment-schedules/{scheduleId}` |

```typescript
// ìŠ¤ì¼€ì¤„ ë“±ë¡ (ì˜¬ë°”ë¥¸ ë°©ë²•)
async schedulePayment(params: {
  paymentId: string;      // ê³ ìœ í•œ ê²°ì œ ID (ì˜ˆ: payment_sub123_1701234567)
  billingKey: string;
  orderName: string;
  amount: number;
  scheduledAt: Date;
  customer: { id: string; email?: string };
}) {
  const response = await fetch(
    `${this.apiUrl}/payments/${params.paymentId}/schedule`,
    {
      method: 'POST',
      headers: {
        'Authorization': `PortOne ${config.apiSecret}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        payment: {
          billingKey: params.billingKey,
          orderName: params.orderName,
          amount: { total: params.amount },
          currency: 'KRW',
          customer: params.customer,
        },
        timeToPay: params.scheduledAt.toISOString(),
      }),
    }
  );
  
  const data = await response.json();
  return {
    scheduleId: data.schedule?.id || params.paymentId,
    ...data,
  };
}

// ìŠ¤ì¼€ì¤„ ì·¨ì†Œ (ì˜¬ë°”ë¥¸ ë°©ë²•)
async cancelSchedule(scheduleId: string) {
  // DELETE ë©”ì„œë“œ ì‚¬ìš©!
  const response = await fetch(
    `${this.apiUrl}/payment-schedules/${scheduleId}`,
    {
      method: 'DELETE',
      headers: {
        'Authorization': `PortOne ${config.apiSecret}`,
      },
    }
  );
  
  if (!response.ok && response.status !== 404) {
    throw new Error('ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ì‹¤íŒ¨');
  }
}
```

### 7.3 ìŠ¤ì¼€ì¤„ ìƒíƒœ (Schedule Status)

| ìƒíƒœ | ì˜ë¯¸ | ì·¨ì†Œ ê°€ëŠ¥ |
|------|------|----------|
| `SCHEDULED` | ì˜ˆì•½ë¨, ì•„ì§ ì‹¤í–‰ ì•ˆ ë¨ | âœ… ê°€ëŠ¥ |
| `SUCCEEDED` | ê²°ì œ ì™„ë£Œë¨ | âŒ ë¶ˆê°€ëŠ¥ (ì´ë¯¸ ì‹¤í–‰) |
| `REVOKED` | ì·¨ì†Œë¨ | âŒ ë¶ˆê°€ëŠ¥ (ì´ë¯¸ ì·¨ì†Œ) |
| `FAILED` | ê²°ì œ ì‹¤íŒ¨ | âŒ ë¶ˆê°€ëŠ¥ |

### 7.4 Webhookì—ì„œ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ ë“±ë¡ (í•„ìˆ˜!)

**âŒ ì˜ëª»ëœ êµ¬í˜„ (2ê°œì›” í›„ ìë™ê²°ì œ ì¤‘ë‹¨):**
```typescript
private async handlePaymentPaid(data: any): Promise<void> {
  // êµ¬ë… ê¸°ê°„ë§Œ ê°±ì‹ í•˜ê³  ë
  await billingService.updateSubscription(subscriptionId, {
    currentPeriodEnd: nextMonth,
    status: 'active',
  });
  // âŒ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ ë¯¸ë“±ë¡!
}
```

**âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ (ì˜êµ¬ ìë™ê²°ì œ):**
```typescript
private async handlePaymentPaid(data: any): Promise<void> {
  const subscription = await billingService.getSubscriptionById(subscriptionId);
  
  // 1. í•´ì§€ ìš”ì²­ëœ êµ¬ë…ì¸ì§€ í™•ì¸
  if (subscription.canceledAt) {
    console.log('[Webhook] Subscription is canceled, not scheduling next payment');
    return;  // ë‹¤ìŒ ìŠ¤ì¼€ì¤„ ë“±ë¡ ì•ˆí•¨ â†’ ì´ë²ˆì´ ë§ˆì§€ë§‰ ê²°ì œ
  }
  
  // 2. êµ¬ë… ê¸°ê°„ ê°±ì‹ 
  const nextPeriodStart = new Date();
  const nextPeriodEnd = new Date(nextPeriodStart);
  nextPeriodEnd.setMonth(nextPeriodEnd.getMonth() + 1);
  
  // 3. ë‹¤ìŒ ë‹¬ ê²°ì œ ìŠ¤ì¼€ì¤„ ë“±ë¡ (í•µì‹¬!)
  const nextScheduleId = `payment_${subscriptionId}_${Date.now()}`;
  await portoneService.schedulePayment({
    paymentId: nextScheduleId,
    billingKey: subscription.billingKeyId,
    orderName: `${planName} ì •ê¸°ê²°ì œ`,
    amount: plan.priceMonthlyKrw,
    scheduledAt: nextPeriodEnd,
    customer: { id: subscription.userId, email: userEmail },
  });
  
  // 4. DB ì—…ë°ì´íŠ¸ (ìƒˆ ìŠ¤ì¼€ì¤„ ID ì €ì¥!)
  await billingService.updateSubscription(subscriptionId, {
    currentPeriodStart: nextPeriodStart,
    currentPeriodEnd: nextPeriodEnd,
    portoneScheduleId: nextScheduleId,  // ìƒˆ ìŠ¤ì¼€ì¤„ ID ì €ì¥!
    status: 'active',
  });
}
```

---

## 8. êµ¬ë… í•´ì§€ vs í™˜ë¶ˆ - í•µì‹¬ ê°œë… ë¶„ë¦¬ (CRITICAL!)

> âš ï¸ **ì´ ì„¹ì…˜ì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤!** êµ¬ë… í•´ì§€ì™€ í™˜ë¶ˆì„ í˜¼ë™í•˜ë©´ ì‹¬ê°í•œ ë²„ê·¸ê°€ ë°œìƒí•©ë‹ˆë‹¤.

### 8.1 ê°œë… ë¹„êµí‘œ

| ê¸°ëŠ¥ | êµ¬ë… í•´ì§€ (Cancel) | í™˜ë¶ˆ (Refund) |
|------|-------------------|---------------|
| **íŠ¸ë¦¬ê±°** | ì‚¬ìš©ìê°€ "êµ¬ë… í•´ì§€" ë²„íŠ¼ í´ë¦­ | ê´€ë¦¬ìê°€ í™˜ë¶ˆ ìš”ì²­ ìŠ¹ì¸ |
| **ê²°ì œ ì·¨ì†Œ** | âŒ ì•ˆí•¨ (ì´ë¯¸ ê²°ì œëœ ê¸ˆì•¡ ìœ ì§€) | âœ… ì‹¤ì œ ê²°ì œ ì·¨ì†Œ |
| **í˜„ì¬ í”Œëœ** | âœ… ìœ ì§€ (currentPeriodEndê¹Œì§€) | âŒ ì¦‰ì‹œ Free ì „í™˜ |
| **ì‚¬ìš©ëŸ‰ í•œë„** | âœ… ìœ ì§€ | Free í”Œëœ í•œë„ë¡œ ë³€ê²½ |
| **ë‹¤ìŒ ê²°ì œ** | âŒ ì¤‘ë‹¨ (ìŠ¤ì¼€ì¤„ ì·¨ì†Œ) | âŒ ì¤‘ë‹¨ |
| **DB ë³€ê²½** | `canceledAt` ì„¤ì •ë§Œ | `status='cancelled'`, `planId='free'` |

### 8.2 ì˜ëª»ëœ êµ¬í˜„ (ë²„ê·¸ ì›ì¸)

```typescript
// âŒ ì˜ëª»ëœ êµ¬í˜„ - êµ¬ë… í•´ì§€ì—ì„œ ì¦‰ì‹œ Free ì „í™˜
router.post('/cancel', async (req, res) => {
  await portoneService.cancelSubscription(subscriptionId);
  await billingService.cancelSubscription(subscriptionId); // âŒ ì´ê±° í•˜ë©´ ì•ˆë¨!
});
```

### 8.3 ì˜¬ë°”ë¥¸ êµ¬í˜„

```typescript
// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ - êµ¬ë… í•´ì§€
router.post('/cancel', async (req, res) => {
  // canceledAt ì„¤ì • + ë‹¤ìŒ ê²°ì œ ìŠ¤ì¼€ì¤„ ì·¨ì†Œë§Œ
  // í˜„ì¬ í”Œëœ/ì‚¬ìš©ëŸ‰ì€ ê·¸ëŒ€ë¡œ ìœ ì§€!
  await portoneService.cancelSubscription(subscriptionId, userEmail);
  
  res.json({ 
    message: `êµ¬ë… í•´ì§€ê°€ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤. ${periodEndDate}ê¹Œì§€ í˜„ì¬ í”Œëœì„ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
  });
});

// âœ… ì˜¬ë°”ë¥¸ êµ¬í˜„ - í™˜ë¶ˆ ìŠ¹ì¸ (ê´€ë¦¬ì)
router.post('/admin/refunds/:id/approve', async (req, res) => {
  // 1. PortOne APIë¡œ ì‹¤ì œ ê²°ì œ ì·¨ì†Œ
  await portoneService.cancelPayment(paymentId, reason);
  
  // 2. ì´ë•Œë§Œ Free í”Œëœ ì „í™˜ + ì‚¬ìš©ëŸ‰ í•œë„ ì—…ë°ì´íŠ¸
  await billingService.cancelSubscription(subscriptionId);
});
```

### 8.4 í•µì‹¬ í•¨ìˆ˜ ì—­í•  ë¶„ë¦¬

#### portoneService.cancelSubscription()
```typescript
// ì—­í• : ë‹¤ìŒ ìë™ê²°ì œ ì¤‘ë‹¨ + canceledAt ì„¤ì •
// í˜„ì¬ í”Œëœì€ ìœ ì§€í•¨!
async cancelSubscription(subscriptionId: string, userEmail?: string) {
  // 1. canceledAtë§Œ ì„¤ì • (status, planId ë³€ê²½ ì•ˆí•¨!)
  await db.update(userSubscriptions)
    .set({ canceledAt: new Date() })
    .where(eq(userSubscriptions.id, subscriptionId));
  
  // 2. ì˜ˆì •ëœ ë‹¤ìŒ ê²°ì œ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ
  if (subscription.portoneScheduleId) {
    await this.cancelSchedule(subscription.portoneScheduleId);
  }
  
  // 3. í•´ì§€ ì˜ˆì • ì´ë©”ì¼ ë°œì†¡
  await emailService.sendSubscriptionCanceled({...});
}
```

#### billingService.cancelSubscription()
```typescript
// ì—­í• : ì¦‰ì‹œ Free í”Œëœ ì „í™˜ + ì‚¬ìš©ëŸ‰ í•œë„ ì—…ë°ì´íŠ¸
// í™˜ë¶ˆ ìŠ¹ì¸ ì‹œì—ë§Œ í˜¸ì¶œ!
async cancelSubscription(subscriptionId: string) {
  // 1. êµ¬ë…ì„ Free í”Œëœìœ¼ë¡œ ë³€ê²½
  await db.update(userSubscriptions)
    .set({ 
      status: 'cancelled',
      planId: 'vidhub_free',
      canceledAt: new Date()
    })
    .where(eq(userSubscriptions.id, subscriptionId));
  
  // 2. ì‚¬ìš©ëŸ‰ í•œë„ë¥¼ Free í”Œëœ ê¸°ì¤€ìœ¼ë¡œ ì—…ë°ì´íŠ¸
  const freePlan = await this.getPlanById('vidhub_free');
  await this.updateUserUsageLimits(userId, freePlan);
}
```

### 8.5 í•¨ìˆ˜ í˜¸ì¶œ ì‹œì  ì •ë¦¬

| ìƒí™© | portoneService.cancelSubscription | billingService.cancelSubscription |
|------|-----------------------------------|-----------------------------------|
| êµ¬ë… í•´ì§€ ë²„íŠ¼ í´ë¦­ | âœ… í˜¸ì¶œ | âŒ í˜¸ì¶œ ì•ˆí•¨ |
| í™˜ë¶ˆ ìš”ì²­ ìŠ¹ì¸ | - | âœ… í˜¸ì¶œ |
| currentPeriodEnd ë„ë‹¬ ì‹œ (ìŠ¤ì¼€ì¤„ëŸ¬) | - | âœ… í˜¸ì¶œ |

---

## 9. í™˜ë¶ˆ ì •ì±… (í•œêµ­ ì „ììƒê±°ë˜ë²• ì¤€ìˆ˜)

### 9.1 í™˜ë¶ˆ ì •ì±… ê·œì¹™

| ì¡°ê±´ | í™˜ë¶ˆìœ¨ | ë¹„ê³  |
|------|--------|------|
| ê²°ì œ í›„ 7ì¼ ì´ë‚´ + ë¯¸ì‚¬ìš© | 100% | ì²­ì•½ì² íšŒ ê¸°ê°„ |
| ê²°ì œ í›„ 7ì¼ ì´ë‚´ + ì¼ë¶€ ì‚¬ìš© | ì¼í•  ê³„ì‚° | ì‚¬ìš©ì¼ìˆ˜ ì°¨ê° |
| ê²°ì œ í›„ 7ì¼ ì´ˆê³¼ | ì¼í•  ê³„ì‚° | ì”ì—¬ ê¸°ê°„ ê¸°ì¤€ |
| PayPal ê²°ì œ | í™˜ë¶ˆì•¡ - 3% | PayPal ìˆ˜ìˆ˜ë£Œ |

### 9.2 í™˜ë¶ˆ ê³„ì‚° í•¨ìˆ˜

```typescript
async calculateRefundAmount(subscriptionId: string) {
  const subscription = await this.getSubscriptionById(subscriptionId);
  const payment = await storage.getPaymentTransactionBySubscriptionId(subscriptionId);
  
  const now = new Date();
  const paymentDate = new Date(payment.createdAt);
  const periodEnd = new Date(subscription.currentPeriodEnd);
  
  const daysSincePayment = Math.floor((now - paymentDate) / (1000 * 60 * 60 * 24));
  const totalDays = Math.floor((periodEnd - paymentDate) / (1000 * 60 * 60 * 24));
  const remainingDays = Math.max(0, totalDays - daysSincePayment);
  
  // 7ì¼ ì´ë‚´ ì „ì•¡ í™˜ë¶ˆ (ì²­ì•½ì² íšŒ)
  if (daysSincePayment <= 7) {
    return {
      refundAmount: payment.amount,
      refundType: 'full',
      reason: 'ì²­ì•½ì² íšŒ (7ì¼ ì´ë‚´)'
    };
  }
  
  // ì¼í•  ê³„ì‚°
  const dailyRate = payment.amount / totalDays;
  const refundAmount = Math.floor(dailyRate * remainingDays);
  
  return {
    refundAmount,
    refundType: 'partial',
    reason: `ì¼í•  ê³„ì‚°: ${remainingDays}ì¼ ì”ì—¬`
  };
}
```

### 9.3 ì•…ìš© ë°©ì§€ ì •ì±…

```typescript
// í™˜ë¶ˆ ì‹œ ì‚¬ìš©ëŸ‰ì€ ìœ ì§€ (Free í•œë„ ì ìš©)
// ê²°ì œ â†’ ì‚¬ìš© â†’ í™˜ë¶ˆ â†’ ë¦¬ì…‹ ì•…ìš© ë°©ì§€
async cancelSubscription(subscriptionId: string) {
  // í”Œëœì€ Freeë¡œ ì „í™˜
  await db.update(userSubscriptions).set({ planId: 'vidhub_free' });
  
  // ì‚¬ìš©ëŸ‰ í•œë„ë§Œ Freeë¡œ ë³€ê²½ (ì‚¬ìš©ëŸ‰ ìì²´ëŠ” ìœ ì§€!)
  await db.update(userUsage).set({ 
    limitInPeriod: freePlan.features.summary_limit_month 
  });
  // usedInPeriodëŠ” ë¦¬ì…‹ ì•ˆí•¨!
}
```

---

## 10. ì—…ê·¸ë ˆì´ë“œ ì‹œ ìë™ í™˜ë¶ˆ ë¡œì§

### 10.1 ë¬¸ì œ ìƒí™©
- ì‚¬ìš©ìê°€ Basic(â‚©4,900) ê²°ì œ â†’ ë°”ë¡œ Pro(â‚©9,900)ë¡œ ì—…ê·¸ë ˆì´ë“œ
- Basic ê²°ì œê¸ˆì´ í”Œë«í¼ì— ê·€ì†ë˜ë©´ ì•ˆë¨ â†’ ìë™ í™˜ë¶ˆ í•„ìš”

### 10.2 êµ¬í˜„

```typescript
async createSubscription(params) {
  // 1. ê¸°ì¡´ êµ¬ë… í™•ì¸
  const existingSubscription = await this.getUserSubscription(params.userId);
  let upgradeRefundResult = null;
  
  // 2. ìœ ë£Œ â†’ ìœ ë£Œ ì—…ê·¸ë ˆì´ë“œì¸ ê²½ìš° ê¸°ì¡´ ê²°ì œ í™˜ë¶ˆ
  if (existingSubscription && !existingSubscription.planId.includes('free')) {
    const lastPayment = await storage.getPaymentTransactionBySubscriptionId(
      existingSubscription.id
    );
    
    if (lastPayment && lastPayment.status !== 'refunded') {
      try {
        // PortOne APIë¡œ í™˜ë¶ˆ
        await portoneService.cancelPayment(
          lastPayment.portonePaymentId,
          `ì—…ê·¸ë ˆì´ë“œë¡œ ì¸í•œ ìë™ í™˜ë¶ˆ: ${existingSubscription.planId} â†’ ${params.planId}`
        );
        
        // PayPal ìˆ˜ìˆ˜ë£Œ ë¡œê¹…
        if (lastPayment.paymentMethod === 'paypal') {
          const fee = lastPayment.amount * 0.03;
          console.log(`[Billing] PayPal refund fee: ${fee} USD`);
        }
        
        upgradeRefundResult = { success: true, refundedAmount: lastPayment.amount };
      } catch (error) {
        upgradeRefundResult = { success: false, error: error.message };
        // í™˜ë¶ˆ ì‹¤íŒ¨í•´ë„ ì—…ê·¸ë ˆì´ë“œëŠ” ì§„í–‰ (ë¡œê¹… í›„ ìˆ˜ë™ ì²˜ë¦¬)
      }
    }
  }
  
  // 3. ìƒˆ êµ¬ë… ìƒì„±
  const newSubscription = await this.processNewSubscription(params);
  
  return { ...newSubscription, upgradeRefundResult };
}
```

### 10.3 ê²°ì œ ì¡°íšŒ í•¨ìˆ˜ (storage.ts)

```typescript
// í™˜ë¶ˆë˜ì§€ ì•Šì€ ë§ˆì§€ë§‰ ê²°ì œ ì¡°íšŒ
async getPaymentTransactionBySubscriptionId(subscriptionId: string) {
  const [transaction] = await db
    .select()
    .from(paymentTransactions)
    .where(and(
      eq(paymentTransactions.subscriptionId, subscriptionId),
      ne(paymentTransactions.status, 'refunded')  // ì´ë¯¸ í™˜ë¶ˆëœ ê±´ ì œì™¸
    ))
    .orderBy(desc(paymentTransactions.createdAt))
    .limit(1);
  return transaction;
}
```

---

## 11. PGì‚¬ ì‹¬ì‚¬ í•„ìˆ˜ í˜ì´ì§€

KGì´ë‹ˆì‹œìŠ¤ ë“± PGì‚¬ ì‹¬ì‚¬ í†µê³¼ë¥¼ ìœ„í•´ í•„ìˆ˜ë¡œ í¬í•¨í•´ì•¼ í•˜ëŠ” í˜ì´ì§€:

### 11.1 ì´ìš©ì•½ê´€ (`/terms`)

```markdown
# ì´ìš©ì•½ê´€

## ì œ1ì¡° (ëª©ì )
ë³¸ ì•½ê´€ì€ [íšŒì‚¬ëª…]ì´ ìš´ì˜í•˜ëŠ” [ì„œë¹„ìŠ¤ëª…]ì˜ ì„œë¹„ìŠ¤ ì´ìš©ì— ê´€í•œ ì¡°ê±´ê³¼ ì ˆì°¨ë¥¼ ê·œì •í•©ë‹ˆë‹¤.

## ì œ2ì¡° (ì •ì˜)
1. "ì„œë¹„ìŠ¤"ë€ [ì„œë¹„ìŠ¤ ì„¤ëª…]
2. "íšŒì›"ì´ë€ [íšŒì› ì •ì˜]
...
```

### 11.2 ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ (`/privacy`)

```markdown
# ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨

## 1. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ í•­ëª©
- ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ (íšŒì›ê°€ì… ì‹œ)
- ê²°ì œ ì •ë³´ (ê²°ì œ ì‹œ)
...

## 2. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ ë° ì´ìš©ëª©ì 
...

## 3. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš©ê¸°ê°„
...
```

### 11.3 í™˜ë¶ˆì •ì±… (`/refund`)

```markdown
# í™˜ë¶ˆì •ì±…

## í™˜ë¶ˆ ê°€ëŠ¥ ì¡°ê±´
1. ê²°ì œ í›„ 7ì¼ ì´ë‚´ ì²­ì•½ì² íšŒ ê°€ëŠ¥
2. ì„œë¹„ìŠ¤ ì´ìš© ì „ 100% í™˜ë¶ˆ
3. ì¼ë¶€ ì´ìš© ì‹œ ì¼í•  ê³„ì‚° í™˜ë¶ˆ
...

## í™˜ë¶ˆ ì ˆì°¨
1. ë§ˆì´í˜ì´ì§€ì—ì„œ í™˜ë¶ˆ ìš”ì²­
2. ê´€ë¦¬ì ê²€í†  í›„ ìŠ¹ì¸/ê±°ë¶€
3. ìŠ¹ì¸ ì‹œ ì›ê²°ì œìˆ˜ë‹¨ìœ¼ë¡œ í™˜ë¶ˆ
```

### 11.4 Footer í•„ìˆ˜ ì •ë³´

```tsx
<footer className="text-sm text-gray-600">
  <p>ìƒí˜¸ëª…: [íšŒì‚¬ëª…] | ëŒ€í‘œ: [ëŒ€í‘œìëª…]</p>
  <p>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 000-00-00000</p>
  <p>í†µì‹ íŒë§¤ì—…ì‹ ê³ : ì œ0000-ì„œìš¸XX-0000í˜¸</p>
  <p>ì£¼ì†Œ: [ì‚¬ì—…ì¥ ì£¼ì†Œ]</p>
  <p>ì´ë©”ì¼: support@example.com | ì „í™”: 02-0000-0000</p>
  <a href="/terms">ì´ìš©ì•½ê´€</a> | <a href="/privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a> | <a href="/refund">í™˜ë¶ˆì •ì±…</a>
</footer>
```

### 11.5 ê²°ì œ ì „ ë™ì˜ ì²´í¬ë°•ìŠ¤

```tsx
<div className="space-y-2">
  <label className="flex items-center gap-2">
    <Checkbox 
      checked={agreedToTerms} 
      onCheckedChange={setAgreedToTerms}
      required
    />
    <span>[í•„ìˆ˜] ì´ìš©ì•½ê´€ ë° ê²°ì œì— ë™ì˜í•©ë‹ˆë‹¤</span>
  </label>
  
  <label className="flex items-center gap-2">
    <Checkbox 
      checked={agreedToRefund} 
      onCheckedChange={setAgreedToRefund}
      required
    />
    <span>[í•„ìˆ˜] í™˜ë¶ˆì •ì±…ì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤</span>
  </label>
</div>

<Button 
  onClick={handlePayment}
  disabled={!agreedToTerms || !agreedToRefund}
>
  ê²°ì œí•˜ê¸°
</Button>
```

---

## 12. í…ŒìŠ¤íŠ¸ í™˜ê²½ ì£¼ì˜ì‚¬í•­

### 12.1 PGì‚¬ë³„ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì œí•œ

| PGì‚¬ | í…ŒìŠ¤íŠ¸ ì œí•œ | í•´ê²° ë°©ë²• |
|------|-----------|----------|
| KGì´ë‹ˆì‹œìŠ¤ | SMS ë¯¸ë°œì†¡ | ì‹¤ì„œë¹„ìŠ¤ MID ë°œê¸‰ ë˜ëŠ” PortOne ë¬¸ì˜ |
| ì¹´ì¹´ì˜¤í˜ì´ | - | ëŒ€ë¶€ë¶„ ì •ìƒ ë™ì‘ |
| PayPal | Sandbox ê³„ì • í•„ìš” | developer.paypal.comì—ì„œ í…ŒìŠ¤íŠ¸ ê³„ì • ìƒì„± |

### 12.2 ê´€ë¦¬ì 1ì› í…ŒìŠ¤íŠ¸ ê²°ì œ

```typescript
// ì‹¤ì œ ê²°ì œ ì²˜ë¦¬ ì „ì— ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
const isTestPayment = isAdminEmail(params.userEmail);
const actualAmount = isTestPayment ? 1 : plan.priceMonthlyKrw;

if (isTestPayment) {
  console.log(`[PortOne] Admin test payment: ${params.userEmail} - 1ì›`);
}
```

### 12.3 êµ¬ë… ì·¨ì†Œ í…ŒìŠ¤íŠ¸

```typescript
// êµ¬ë… ì·¨ì†Œ ì‹œ ì¦‰ì‹œ í•´ì§€ê°€ ì•„ë‹Œ "ê¸°ê°„ ì¢…ë£Œ í›„ í•´ì§€"
await db
  .update(userSubscriptions)
  .set({
    canceledAt: new Date(),  // ì·¨ì†Œ ìš”ì²­ ì‹œê°„ë§Œ ê¸°ë¡
    // statusëŠ” active ìœ ì§€ â†’ ê¸°ê°„ ì¢…ë£Œ í›„ expiredë¡œ ë³€ê²½
  })
  .where(eq(userSubscriptions.id, subscriptionId));

// ë‹¤ìŒ ì •ê¸°ê²°ì œ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ
await portoneService.cancelSchedule(scheduleId);
```

---

## 13. ê´€ë¦¬ì ê¸°ëŠ¥

### 13.1 ìŠ¤ì¼€ì¤„ ì¡°íšŒ/ì·¨ì†Œ (PortOne ëŒ€ì‹œë³´ë“œ ì—†ì´)

```typescript
// server/routes/billing.ts

// ìŠ¤ì¼€ì¤„ ì¡°íšŒ
router.get('/admin/schedule/:scheduleId', authMiddleware, adminMiddleware, async (req, res) => {
  const { scheduleId } = req.params;
  const schedule = await portoneService.getSchedule(scheduleId);
  
  if (!schedule) {
    return res.status(404).json({ message: 'ìŠ¤ì¼€ì¤„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
  }
  
  res.json({ 
    success: true, 
    schedule: {
      id: schedule.id,
      status: schedule.status,      // SCHEDULED | SUCCEEDED | REVOKED | FAILED
      orderName: schedule.orderName,
      timeToPay: schedule.timeToPay,
      totalAmount: schedule.totalAmount,
    }
  });
});

// ìŠ¤ì¼€ì¤„ ì·¨ì†Œ
router.post('/admin/cancel-schedule', authMiddleware, adminMiddleware, async (req, res) => {
  const { scheduleId } = req.body;
  
  if (!scheduleId) {
    return res.status(400).json({ message: 'scheduleId is required' });
  }
  
  await portoneService.cancelSchedule(scheduleId);
  res.json({ success: true, message: `ìŠ¤ì¼€ì¤„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤: ${scheduleId}` });
});
```

### 13.2 ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì„œë¹„ìŠ¤ ë©”ì„œë“œ

```typescript
// server/services/portone.ts

async getSchedule(scheduleId: string) {
  const config = this.getConfig();
  
  const response = await fetch(
    `${this.apiUrl}/payments/${scheduleId}/schedule`,
    {
      method: 'GET',
      headers: {
        'Authorization': `PortOne ${config.apiSecret}`,
      },
    }
  );
  
  if (!response.ok) {
    if (response.status === 404) return null;
    throw new Error(`ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`);
  }
  
  const data = await response.json();
  return data.schedule;
}
```

### 13.3 ì£¼ì˜ì‚¬í•­

- **SCHEDULED** ìƒíƒœë§Œ ì·¨ì†Œ ê°€ëŠ¥
- **SUCCEEDED** ìƒíƒœëŠ” ì´ë¯¸ ê²°ì œ ì™„ë£Œ â†’ í™˜ë¶ˆ ì²˜ë¦¬ í•„ìš”
- **REVOKED** ìƒíƒœëŠ” ì´ë¯¸ ì·¨ì†Œë¨
- ìŠ¤ì¼€ì¤„ IDëŠ” `user_subscriptions.portoneScheduleId`ì—ì„œ í™•ì¸

---

## 14. ì¼ë°˜ì ì¸ ì‹¤ìˆ˜ì™€ í•´ê²°ì±…

### 14.1 portoneSubscriptionId vs ë‚´ë¶€ DB ID í˜¼ë™

```typescript
// âŒ ì˜ëª»ëœ ì˜ˆ - ì™¸ë¶€ IDë¡œ DB ì¡°íšŒ
await db.select().from(userSubscriptions)
  .where(eq(userSubscriptions.id, portoneSubscriptionId));  // ì—ëŸ¬!

// âœ… ì˜¬ë°”ë¥¸ ì˜ˆ - ë‚´ë¶€ DB IDë¡œ ì¡°íšŒ
await db.select().from(userSubscriptions)
  .where(eq(userSubscriptions.id, internalSubscriptionId));

// ë˜ëŠ” ì™¸ë¶€ IDë¡œ ì¡°íšŒí•˜ë ¤ë©´
await db.select().from(userSubscriptions)
  .where(eq(userSubscriptions.portoneSubscriptionId, portoneSubscriptionId));
```

### 14.2 í•¨ìˆ˜ê°€ ë‚´ë¶€ IDë¥¼ ë°›ëŠ”ì§€ ì™¸ë¶€ IDë¥¼ ë°›ëŠ”ì§€ ëª…í™•íˆ

```typescript
// í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ì— ëª…í™•íˆ í‘œì‹œ
async cancelSubscription(
  subscriptionId: string,  // ë‚´ë¶€ DB ID (uuid)
  userEmail?: string
) {
  // ë‚´ë¶€ì—ì„œ lookup í›„ portoneScheduleId ì‚¬ìš©
  const [subscription] = await db.select()
    .from(userSubscriptions)
    .where(eq(userSubscriptions.id, subscriptionId));
  
  if (subscription.portoneScheduleId) {
    await this.cancelSchedule(subscription.portoneScheduleId);
  }
}
```

### 14.3 êµ¬ë… í•´ì§€ í›„ UI ë¯¸ë°˜ì˜

```typescript
// ë¬¸ì œ: êµ¬ë… í•´ì§€ API ì„±ê³µ í›„ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ìƒíƒœê°€ ì•ˆ ë°”ë€œ
// ì›ì¸: React Query ìºì‹œ ë¬´íš¨í™” ì•ˆí•¨

// âœ… í•´ê²°: ìºì‹œ ë¬´íš¨í™” í•„ìˆ˜
const cancelMutation = useMutation({
  mutationFn: async () => {
    await apiRequest('POST', '/api/billing/cancel');
  },
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['/api/billing/subscription'] });
    queryClient.invalidateQueries({ queryKey: ['/api/billing/quota'] });
    toast.success('êµ¬ë…ì´ í•´ì§€ë˜ì—ˆìŠµë‹ˆë‹¤');
  }
});
```

### 14.4 PortOne ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ì‹¤íŒ¨

```typescript
// ë¬¸ì œ: ìŠ¤ì¼€ì¤„ IDê°€ ì—†ê±°ë‚˜ ì´ë¯¸ ì·¨ì†Œëœ ê²½ìš°
// í•´ê²°: ë°©ì–´ì  ì²˜ë¦¬

if (subscription.portoneScheduleId) {
  try {
    await this.cancelSchedule(subscription.portoneScheduleId);
  } catch (e) {
    console.error('[PortOne] Failed to cancel scheduled payment:', e);
    // ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ì‹¤íŒ¨í•´ë„ í•´ì§€ëŠ” ì§„í–‰
  }
} else {
  console.log('[PortOne] No scheduled payment found to cancel');
}
```

### 14.5 status ë¬¸ìì—´ ë¶ˆì¼ì¹˜

```typescript
// âŒ ë¬¸ì œ: 'canceled' vs 'cancelled' í˜¼ìš©
if (subscription.status === 'canceled') { ... }  // ì–´ë–¤ ì½”ë“œ
if (subscription.status === 'cancelled') { ... } // ë‹¤ë¥¸ ì½”ë“œ

// âœ… í•´ê²°: í”„ë¡œì íŠ¸ ì „ì²´ì—ì„œ 'cancelled' í†µì¼
const SUBSCRIPTION_STATUS = {
  ACTIVE: 'active',
  CANCELLED: 'cancelled',  // 'canceled' ì•„ë‹˜!
  PAST_DUE: 'past_due',
  PENDING: 'pending'
} as const;
```

---

## 15. ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì‚¬ì „ ì¤€ë¹„
- [ ] PortOne ì½˜ì†” ìŠ¤í† ì–´ ìƒì„±
- [ ] KGì´ë‹ˆì‹œìŠ¤ ì •ê¸°ê²°ì œ ì±„ë„ ì¶”ê°€
- [ ] ì¹´ì¹´ì˜¤í˜ì´ ì •ê¸°ê²°ì œ ì±„ë„ ì¶”ê°€
- [ ] PayPal RT ì±„ë„ ì¶”ê°€ (ì„ íƒ)
- [ ] Resend ê³„ì • ìƒì„± ë° API í‚¤ ë°œê¸‰

### í™˜ê²½ ë³€ìˆ˜
- [ ] `PORTONE_API_SECRET` ì„¤ì •
- [ ] `PORTONE_STORE_ID` ì„¤ì •
- [ ] `PORTONE_CHANNEL_KEY` ì„¤ì •
- [ ] `PORTONE_KAKAOPAY_CHANNEL_KEY` ì„¤ì •
- [ ] `PORTONE_PAYPAL_CHANNEL_KEY` ì„¤ì • (ì„ íƒ)
- [ ] `RESEND_API_KEY` ì„¤ì •
- [ ] `ADMIN_EMAILS` ì„¤ì •

### ë°ì´í„°ë² ì´ìŠ¤
- [ ] `billing_plans` í…Œì´ë¸” ìƒì„±
- [ ] `user_subscriptions` í…Œì´ë¸” ìƒì„±
- [ ] `payment_transactions` í…Œì´ë¸” ìƒì„±
- [ ] `refund_requests` í…Œì´ë¸” ìƒì„±
- [ ] `user_usage` í…Œì´ë¸” ìƒì„±
- [ ] ì´ˆê¸° ìš”ê¸ˆì œ ë°ì´í„° ì‚½ì…

### ë°±ì—”ë“œ
- [ ] PortOne ì„œë¹„ìŠ¤ êµ¬í˜„
- [ ] Billing ì„œë¹„ìŠ¤ êµ¬í˜„ (êµ¬ë… í•´ì§€ vs í™˜ë¶ˆ ë¶„ë¦¬!)
- [ ] Billing ë¼ìš°íŠ¸ êµ¬í˜„
- [ ] Email ì„œë¹„ìŠ¤ êµ¬í˜„
- [ ] Admin ì„¤ì • êµ¬í˜„
- [ ] Webhook ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [ ] Webhookì—ì„œ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ ë“±ë¡ ë¡œì§ (ì„¹ì…˜ 7.4 í•„ìˆ˜!)
- [ ] êµ¬ë… í•´ì§€ ì‹œ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ë¡œì§ (í”Œëœì€ ìœ ì§€!)
- [ ] í™˜ë¶ˆ ìŠ¹ì¸ ì‹œì—ë§Œ Free í”Œëœ ì „í™˜
- [ ] ì—…ê·¸ë ˆì´ë“œ ì‹œ ìë™ í™˜ë¶ˆ ë¡œì§
- [ ] ê´€ë¦¬ì ìŠ¤ì¼€ì¤„ ì¡°íšŒ/ì·¨ì†Œ API

### í”„ë¡ íŠ¸ì—”ë“œ
- [ ] PortOne SDK ë¡œë“œ
- [ ] ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ UI
- [ ] ì¹´ë“œ ë¹Œë§í‚¤ ë°œê¸‰ êµ¬í˜„
- [ ] ì¹´ì¹´ì˜¤í˜ì´ ë¹Œë§í‚¤ ë°œê¸‰ êµ¬í˜„
- [ ] PayPal ë²„íŠ¼ ë Œë”ë§ êµ¬í˜„
- [ ] ê²°ì œ ì„±ê³µ/ì‹¤íŒ¨ ì²˜ë¦¬
- [ ] êµ¬ë… í•´ì§€ í›„ ìºì‹œ ë¬´íš¨í™”

### PGì‚¬ ì‹¬ì‚¬
- [ ] ì´ìš©ì•½ê´€ í˜ì´ì§€
- [ ] ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€
- [ ] í™˜ë¶ˆì •ì±… í˜ì´ì§€
- [ ] Footerì— ì‚¬ì—…ì ì •ë³´
- [ ] ê²°ì œ ì „ ë™ì˜ ì²´í¬ë°•ìŠ¤

### í…ŒìŠ¤íŠ¸
- [ ] êµ¬ë… í•´ì§€ ì‹œ í”Œëœ ìœ ì§€ í™•ì¸
- [ ] í™˜ë¶ˆ ìŠ¹ì¸ ì‹œ Free í”Œëœ ì „í™˜ í™•ì¸
- [ ] ì—…ê·¸ë ˆì´ë“œ ì‹œ ìë™ í™˜ë¶ˆ í™•ì¸
- [ ] PayPal í™˜ë¶ˆ 3% ìˆ˜ìˆ˜ë£Œ ë¡œê¹… í™•ì¸
- [ ] ì¹´ë“œ ê²°ì œ í…ŒìŠ¤íŠ¸
- [ ] ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ í…ŒìŠ¤íŠ¸
- [ ] PayPal ê²°ì œ í…ŒìŠ¤íŠ¸ (Sandbox)
- [ ] ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸
- [ ] ê´€ë¦¬ì 1ì› ê²°ì œ í…ŒìŠ¤íŠ¸

---

## 16. ê°œë°œ ëŒ€ì›ì¹™

### 16.1 ì ˆëŒ€ ì¤€ìˆ˜ ì›ì¹™

| ì›ì¹™ | ì„¤ëª… | ìœ„ë°˜ ì‹œ ì¡°ì¹˜ |
|------|------|-------------|
| **ğŸš« í•˜ë“œì½”ë”© ê¸ˆì§€** | ëª¨ë“  ë§ˆìŠ¤í„° ë°ì´í„°ëŠ” DB í…Œì´ë¸”ë¡œ ê´€ë¦¬ | ì½”ë“œ ë¦¬ë·° ê±°ë¶€ |
| **ğŸ›¡ï¸ ê¸°ì¡´ ê¸°ëŠ¥ ë³´ì¡´** | ì •ìƒ ì‘ë™ ì¤‘ì¸ ê¸°ëŠ¥ ì ˆëŒ€ ì‚­ì œ/ë³€ê²½ ê¸ˆì§€ | ë¡¤ë°± í›„ ì¬ì‘ì—… |
| **ğŸ“¦ ì¶”ê°€ ì „ìš© ê°œë°œ** | ìƒˆ ê¸°ëŠ¥ì€ ê¸°ì¡´ ì½”ë“œ ìˆ˜ì • ì—†ì´ ì¶”ê°€ ë°©ì‹ìœ¼ë¡œ | ë³„ë„ íŒŒì¼/í•¨ìˆ˜ë¡œ ë¶„ë¦¬ |
| **ğŸ”§ ê´€ë¦¬ì UI í•„ìˆ˜** | ì„¤ì •ê°’ì€ ë°˜ë“œì‹œ ê´€ë¦¬ì í™”ë©´ì—ì„œ ë³€ê²½ ê°€ëŠ¥í•˜ê²Œ | DB + Admin API í•„ìˆ˜ |

### 16.2 Replit Agent ê²½ê³  ì‚¬í•­

```
âš ï¸ ì£¼ì˜: Replit AgentëŠ” ë‹¤ìŒ í–‰ë™ì„ í•˜ë ¤ëŠ” ê²½í–¥ì´ ìˆìŒ

1. âŒ ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì‹œ ê¸°ì¡´ ì†ŒìŠ¤ì½”ë“œë¥¼ ì™„ì „íˆ ì¬ì‘ì„±
2. âŒ "ë” ë‚˜ì€ êµ¬ì¡°"ë¼ëŠ” ëª…ëª©ìœ¼ë¡œ ì‘ë™ ì¤‘ì¸ ê¸°ëŠ¥ ì‚­ì œ
3. âŒ í•˜ë“œì½”ë”©ëœ ë°°ì—´/ê°ì²´ë¡œ ë§ˆìŠ¤í„° ë°ì´í„° ì •ì˜
4. âŒ ê´€ë¦¬ì ê¸°ëŠ¥ ì—†ì´ ì½”ë“œ ì§ì ‘ ìˆ˜ì •ìœ¼ë¡œë§Œ ì„¤ì • ë³€ê²½ ê°€ëŠ¥í•˜ê²Œ êµ¬í˜„

â†’ ì´ëŸ¬í•œ í–‰ë™ ë°œìƒ ì‹œ ì¦‰ì‹œ ë¡¤ë°±í•˜ê³  ì›ì¹™ì— ë§ê²Œ ì¬êµ¬í˜„
```

---

## ë¶€ë¡: ìì£¼ ë°œìƒí•˜ëŠ” ì—ëŸ¬

### 1. "ì•Œë ¤ì§€ì§€ ì•Šì€ credential" ì—ëŸ¬
- **ì›ì¸:** PortOne ì½˜ì†”ì—ì„œ ì±„ë„ ì„¤ì • ë¶ˆì¼ì¹˜
- **í•´ê²°:** ì±„ë„ í‚¤ê°€ ì˜¬ë°”ë¥¸ PGì‚¬ì™€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

### 2. "NotFoundError: removeChild" (React DOM ì¶©ëŒ)
- **ì›ì¸:** PayPal SDKê°€ DOMì„ ìˆ˜ì •í•˜ê³  Reactê°€ ê°™ì€ DOMì„ ê´€ë¦¬
- **í•´ê²°:** PayPal ì»¨í…Œì´ë„ˆë¥¼ React ì™¸ë¶€ì—ì„œ ìˆ˜ë™ ê´€ë¦¬

### 3. SMS ì¸ì¦ ì½”ë“œ ë¯¸ìˆ˜ì‹ 
- **ì›ì¸:** í…ŒìŠ¤íŠ¸ MIDëŠ” SMS ë¯¸ë°œì†¡
- **í•´ê²°:** ì‹¤ì„œë¹„ìŠ¤ MID ë°œê¸‰ ë˜ëŠ” PortOneì— í…ŒìŠ¤íŠ¸ í™˜ê²½ ë¬¸ì˜

### 4. ì¹´ì¹´ì˜¤í˜ì´ windowType ì—ëŸ¬
- **ì›ì¸:** windowType ë¯¸ì„¤ì • ë˜ëŠ” ì˜ëª»ëœ ê°’
- **í•´ê²°:** `{ pc: 'IFRAME', mobile: 'REDIRECTION' }` í•„ìˆ˜ ì„¤ì •

### 5. PayPal "ì¹´ë“œ ì…ë ¥ìœ¼ë¡œ ì´ë™"
- **ì›ì¸:** Sandbox ê³„ì •ì— ê²°ì œ ìˆ˜ë‹¨ ë¯¸ë“±ë¡
- **í•´ê²°:** developer.paypal.comì—ì„œ í…ŒìŠ¤íŠ¸ ê³„ì •ì— ì”ì•¡/ì¹´ë“œ ë“±ë¡

### 6. ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ì‹¤íŒ¨ (404 ë˜ëŠ” Method Not Allowed)
- **ì›ì¸:** PortOne V2 ìŠ¤ì¼€ì¤„ ì·¨ì†Œ API ì—”ë“œí¬ì¸íŠ¸ ì˜ëª» ì‚¬ìš©
- **í•´ê²°:** 
  - âŒ ì˜ëª»: `POST /payment-schedules/{scheduleId}/revoke`
  - âœ… ì˜¬ë°”ë¦„: `DELETE /payment-schedules/{scheduleId}`

### 7. 2ê°œì›” í›„ ìë™ê²°ì œ ì¤‘ë‹¨
- **ì›ì¸:** Webhookì—ì„œ ë‹¤ìŒ ë‹¬ ìŠ¤ì¼€ì¤„ì„ ë“±ë¡í•˜ì§€ ì•ŠìŒ
- **í•´ê²°:** `handlePaymentPaid`ì—ì„œ ë°˜ë“œì‹œ ë‹¤ìŒ ìŠ¤ì¼€ì¤„ ë“±ë¡ (ì„¹ì…˜ 7.4 ì°¸ì¡°)

### 8. í•´ì§€ í›„ì—ë„ ìë™ê²°ì œ ê³„ì† ë°œìƒ
- **ì›ì¸:** Webhookì—ì„œ `canceledAt` ì²´í¬ ëˆ„ë½
- **í•´ê²°:** 
  ```typescript
  if (subscription.canceledAt) {
    return; // ê°±ì‹ í•˜ì§€ ì•ŠìŒ
  }
  ```

### 9. ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ì‹œ "ì´ë¯¸ ì²˜ë¦¬ë¨" ì—ëŸ¬
- **ì›ì¸:** SUCCEEDED ë˜ëŠ” REVOKED ìƒíƒœì˜ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ ì‹œë„
- **í•´ê²°:** ì·¨ì†Œ ì „ ìƒíƒœ í™•ì¸, SCHEDULED ìƒíƒœë§Œ ì·¨ì†Œ ê°€ëŠ¥

### 10. portoneSubscriptionIdë¡œ ìŠ¤ì¼€ì¤„ ì¡°íšŒ ì‹¤íŒ¨
- **ì›ì¸:** paymentIdì™€ scheduleId í˜¼ë™
- **í•´ê²°:** 
  - `portoneSubscriptionId`: ê²°ì œ ID (ì¦‰ì‹œ ê²°ì œìš©)
  - `portoneScheduleId`: ìŠ¤ì¼€ì¤„ ID (ì˜ˆì•½ ê²°ì œìš©) - ë³„ë„ ì»¬ëŸ¼ í•„ìš”

### 11. êµ¬ë… í•´ì§€ ì‹œ ì¦‰ì‹œ Free í”Œëœ ì „í™˜ ë²„ê·¸
- **ì›ì¸:** êµ¬ë… í•´ì§€ APIì—ì„œ `billingService.cancelSubscription()` í˜¸ì¶œ
- **í•´ê²°:** êµ¬ë… í•´ì§€ ì‹œì—ëŠ” `portoneService.cancelSubscription()`ë§Œ í˜¸ì¶œ, `billingService.cancelSubscription()`ëŠ” í™˜ë¶ˆ ìŠ¹ì¸ ì‹œì—ë§Œ!

### 12. PayPal í™˜ë¶ˆ ì‹œ ìˆ˜ìˆ˜ë£Œ ë¯¸ì²˜ë¦¬
- **ì›ì¸:** PayPal í™˜ë¶ˆ ì‹œ 3% ìˆ˜ìˆ˜ë£Œ ì°¨ê° ë¯¸ì ìš©
- **í•´ê²°:** í™˜ë¶ˆ ë¡œì§ì—ì„œ PayPal ê²°ì œ ì—¬ë¶€ í™•ì¸ í›„ ìˆ˜ìˆ˜ë£Œ ê³„ì‚° ë° ë¡œê¹…

---

> ì´ ë¬¸ì„œëŠ” VidDigest Hub í”„ë¡œì íŠ¸ (2024ë…„ 12ì›”) ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
> PortOne API ë²„ì „: V2
> 
> **ìµœì¢… ì—…ë°ì´íŠ¸:** 2024ë…„ 12ì›” 4ì¼
> - êµ¬ë… í•´ì§€ vs í™˜ë¶ˆ í•µì‹¬ ê°œë… ë¶„ë¦¬ (ì„¹ì…˜ 8)
> - í™˜ë¶ˆ ì •ì±… (í•œêµ­ ì „ììƒê±°ë˜ë²• ì¤€ìˆ˜) (ì„¹ì…˜ 9)
> - ì—…ê·¸ë ˆì´ë“œ ì‹œ ìë™ í™˜ë¶ˆ ë¡œì§ (ì„¹ì…˜ 10)
> - ì¼ë°˜ì ì¸ ì‹¤ìˆ˜ì™€ í•´ê²°ì±… í™•ì¥ (ì„¹ì…˜ 14)
> - ì‹œí–‰ì°©ì˜¤ ê¸°ë°˜ ì—ëŸ¬ ì¼€ì´ìŠ¤ 2ê°œ ì¶”ê°€ (ë¶€ë¡)
